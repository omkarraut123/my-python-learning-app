<!doctype html>
<html>
<body>

<h3><span style="color: #993366;">What is garbage collection and why do we need It?</span></h3>
<h4>Memory management</h4>
<p>A programming language uses objects in its programs to perform operations. Objects include simple variables, like strings, integers, or booleans. They also include more complex data structures like lists, hashes, or classes.</p>
<p>The values of your program&rsquo;s objects are stored in memory for quick access. In many programming languages, a variable in your program code is simply a pointer to the address of the object in memory. When a variable is used in a program, the process will read the value from memory and operate on it.</p>
<p>In early programming languages, developers were responsible for all memory management in their programs. This meant before creating a list or an object, you first needed to allocate the memory for your variable. After you were done with your variable, you then needed to deallocate it to &ldquo;free&rdquo; that memory for other users.</p>
<p>This led to two problems:</p>
<ol>
<li><span style="color: #993366;"><strong>Forgetting to free your memory</strong></span>. If you don&rsquo;t free your memory when you&rsquo;re done using it, it can result in memory leaks. This can lead to your program using too much memory over time. For long-running applications, this can cause serious problems.</li>
<li><span style="color: #993366;"><strong>Freeing your memory too soon</strong></span>. The second type of problem consists of freeing your memory while it&rsquo;s still in use. This can cause your program to crash if it tries to access a value in memory that doesn&rsquo;t exist, or it can corrupt your data. A variable that refers to memory that has been freed is called a dangling pointer</li>
</ol>
<h3><span style="color: #993366;">How Python implements garbage collection</span></h3>
<p>In this section, we&rsquo;ll cover how garbage collection works in Python.</p>
<p>This section assumes you&rsquo;re using the&nbsp;<a href="https://en.wikipedia.org/wiki/CPython" target="_blank" rel="noopener noreferrer" aria-label=" (opens in a new tab)">CPython implementation of Python</a>. CPython is the most widely used implementation. However, there are other implementations of Python, such as&nbsp;<a href="http://pypy.org/" target="_blank" rel="noopener noreferrer">PyPy</a>,&nbsp;<a href="http://www.jython.org/" target="_blank" rel="noopener noreferrer" aria-label=" (opens in a new tab)">Jython</a>&nbsp;(Java-based), or&nbsp;<a href="https://ironpython.net/" target="_blank" rel="noopener noreferrer" aria-label=" (opens in a new tab)">IronPython</a>&nbsp;(C#-based).</p>
<p>To see which Python you&rsquo;re using, run the following command in your terminal:</p>
<pre style="border: 1px dashed #2f6fab; padding: 1em; font-family: monospace,Courier; color: #000000; background-color: #f9f9f9; line-height: 1.3em; font-size: 13px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px;">python -c<span style="color: #00ff00;"> 'import platform; print(platform.python_implementation())';</span></pre>
<p>There are two aspects to memory management and garbage collection in CPython:</p>
<ul>
<li>Reference counting</li>
<li>Generational garbage collection</li>
</ul>
<p>Let&rsquo;s explore each of these below.&nbsp;</p>
<h4><span style="color: #993366;">Reference counting in CPython</span></h4>
<p>The main garbage collection mechanism in CPython is through&nbsp;<a href="https://docs.python.org/3.6/c-api/intro.html#reference-counts" target="_blank" rel="noopener noreferrer" aria-label=" (opens in a new tab)">reference counts</a>. Whenever you create an object in Python, the underlying C object has both a Python type (such as list, dict, or function) and a reference count.</p>
<p>At a very basic level, a Python object&rsquo;s reference count is incremented whenever the object is referenced, and it&rsquo;s decremented when an object is dereferenced. If an object&rsquo;s reference count is 0, the memory for the object is deallocated.</p>
<p>Your program&rsquo;s code can&rsquo;t disable Python&rsquo;s reference counting. This is in contrast to the generational garbage collector discussed below.</p>
<p>Some people claim&nbsp;<a href="https://www.quora.com/Why-doesnt-Apple-Swift-adopt-the-memory-management-method-of-garbage-collection-like-Java-uses#__w2_wTLUJRu99_answer" target="_blank" rel="noopener noreferrer" aria-label=" (opens in a new tab)">reference counting is a poor man&rsquo;s garbage collector</a>. It does have some downsides, including an inability to detect cyclic references as discussed below. However, reference counting is nice because&nbsp;<a href="https://rushter.com/blog/python-garbage-collector/" target="_blank" rel="noopener noreferrer" aria-label=" (opens in a new tab)">you can immediately remove an object when it has no references</a>.</p>
<h5>Viewing reference counts in Python</h5>
<p>You can use the&nbsp;<a href="https://docs.python.org/3/library/sys.html" target="_blank" rel="noopener noreferrer">sys</a>&nbsp;module from the Python standard library to check reference counts for a particular object. There are a few ways to increase the reference count for an object, such as&nbsp;</p>
<ul>
<li>Assigning an object to a variable.</li>
<li>Adding an object to a data structure, such as appending to a list or adding as a property on a class instance.</li>
<li>Passing the object as an argument to a function.</li>
</ul>
<p>Let&rsquo;s use a Python REPL and the sys module to see how reference counts are handled.</p>
<p>First, in your terminal, type&nbsp;<strong>python</strong>&nbsp;to enter into a Python REPL.</p>
<p>Second, import the sys module into your REPL. Then, create a variable and check its reference count:</p>
<pre class="wp-block-preformatted prettyprinted"><span class="pun">&gt;&gt;&gt;</span> <span class="kwd">import</span><span class="pln"> sys</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> a </span><span class="pun">=</span> <span class="str">'my-string'</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> sys</span><span class="pun">.</span><span class="pln">getrefcount</span><span class="pun">(</span><span class="pln">a</span><span class="pun">)</span><br /><span class="lit">2</span></pre>
<p>Notice that there are two references to our variable&nbsp;<strong>a</strong>. One is from creating the variable. The second is when we pass the variable&nbsp;<strong>a</strong>&nbsp;to the&nbsp;<strong>sys.getrefcount()</strong>&nbsp;function.</p>
<p>If you add the variable to a data structure, such as a list or a dictionary, you&rsquo;ll see the reference count increase:</p>
<pre class="wp-block-preformatted prettyprinted"><span class="pun">&gt;&gt;&gt;</span> <span class="kwd">import</span><span class="pln"> sys</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> a </span><span class="pun">=</span> <span class="str">'my-string'</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> b </span><span class="pun">=</span> <span class="pun">[</span><span class="pln">a</span><span class="pun">]</span> <span class="com"># Make a list with a as an element.</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> c </span><span class="pun">=</span> <span class="pun">{</span> <span class="str">'key'</span><span class="pun">:</span><span class="pln"> a </span><span class="pun">}</span> <span class="com"># Create a dictionary with a as one of the values.</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> sys</span><span class="pun">.</span><span class="pln">getrefcount</span><span class="pun">(</span><span class="pln">a</span><span class="pun">)</span><br /><span class="lit">4</span></pre>
<p>As shown above, the reference count of&nbsp;<strong>a</strong>&nbsp;increases when added to a list or a dictionary.</p>
<p>In the next section, we&rsquo;ll learn about the generational garbage collector, which is the second tool Python uses for memory management.</p>
<h4><span style="color: #993366;">Generational garbage collection</span></h4>
<p>In addition to the reference counting strategy for memory management, Python also uses a method called a generational garbage collector.</p>
<p>The easiest way to understand why we need a generational garbage collector is by way of example.</p>
<p>In the previous section, we saw that adding an object to an array or object increased its reference count. But what happens if you add an object to itself?</p>
<pre class="wp-block-preformatted prettyprinted"><span class="pun">&gt;&gt;&gt;</span> <span class="kwd">class</span> <span class="typ">MyClass</span><span class="pun">(</span><span class="kwd">object</span><span class="pun">):</span><br /><span class="pun">...</span><span class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">pass</span><br /><span class="pun">...</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> a </span><span class="pun">=</span> <span class="typ">MyClass</span><span class="pun">()</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> a</span><span class="pun">.</span><span class="pln">obj </span><span class="pun">=</span><span class="pln"> a</span><br /><span class="pun">&gt;&gt;&gt;</span> <span class="kwd">del</span><span class="pln"> a</span></pre>
<p>In the example above, we defined a new class. We then created an instance of the class and assigned the instance to be a property on itself. Finally, we deleted the instance.</p>
<p>By deleting the instance, it&rsquo;s no longer accessible in our Python program. However, Python didn&rsquo;t destroy the instance from memory. The instance doesn&rsquo;t have a reference count of zero because it has a reference to itself.</p>
<p>&nbsp;</p>
<h5><span style="color: #993366;"><strong>Using the GC module</strong></span></h5>
<p>In your terminal, enter&nbsp;<strong>python</strong>&nbsp;to drop into a Python REPL.</p>
<p>Import the&nbsp;<strong>gc</strong>&nbsp;module into your session. You can then check the configured thresholds of your garbage collector with the&nbsp;<strong>get_threshold()</strong>&nbsp;method:</p>
<pre class="wp-block-preformatted prettyprinted"><span class="pun">&gt;&gt;&gt;</span> <span class="kwd">import</span><span class="pln"> gc</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> gc</span><span class="pun">.</span><span class="pln">get_threshold</span><span class="pun">()</span><br /><span class="pun">(</span><span class="lit">700</span><span class="pun">,</span> <span class="lit">10</span><span class="pun">,</span> <span class="lit">10</span><span class="pun">)</span></pre>
<p>By default, Python has a threshold of 700 for the youngest generation and 10 for each of the two older generations.</p>
<p>You can check the number of objects in each of your generations with the&nbsp;<strong>get_count()</strong>&nbsp;method:</p>
<pre class="wp-block-preformatted prettyprinted"><span class="pun">&gt;&gt;&gt;</span> <span class="kwd">import</span><span class="pln"> gc</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> gc</span><span class="pun">.</span><span class="pln">get_count</span><span class="pun">()</span><br /><span class="pun">(</span><span class="lit">596</span><span class="pun">,</span> <span class="lit">2</span><span class="pun">,</span> <span class="lit">1</span><span class="pun">)</span></pre>
<p>In this example, we have 596 objects in our youngest generation, two objects in the next generation, and one object in the oldest generation.</p>
<p>As you can see, Python creates a number of objects by default before you even start executing your program. You can trigger a manual garbage collection process by using the&nbsp;<strong>gc.collect()</strong>&nbsp;method:</p>
<pre class="wp-block-preformatted prettyprinted"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> gc</span><span class="pun">.</span><span class="pln">get_count</span><span class="pun">()</span><br /><span class="pun">(</span><span class="lit">595</span><span class="pun">,</span> <span class="lit">2</span><span class="pun">,</span> <span class="lit">1</span><span class="pun">)</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> gc</span><span class="pun">.</span><span class="pln">collect</span><span class="pun">()</span><br /><span class="lit">57</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> gc</span><span class="pun">.</span><span class="pln">get_count</span><span class="pun">()</span><br /><span class="pun">(</span><span class="lit">18</span><span class="pun">,</span> <span class="lit">0</span><span class="pun">,</span> <span class="lit">0</span><span class="pun">)</span></pre>
<p>Running a garbage collection process cleans up a huge amount of objects&mdash;577 in the first generation and three more in the older generations.</p>
<p>You can alter the thresholds for triggering garbage collection by using the&nbsp;<strong>set_threshold()</strong>&nbsp;method in the gc module:</p>
<pre class="wp-block-preformatted prettyprinted"><span class="pun">&gt;&gt;&gt;</span> <span class="kwd">import</span><span class="pln"> gc</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> gc</span><span class="pun">.</span><span class="pln">get_threshold</span><span class="pun">()</span><br /><span class="pun">(</span><span class="lit">700</span><span class="pun">,</span> <span class="lit">10</span><span class="pun">,</span> <span class="lit">10</span><span class="pun">)</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> gc</span><span class="pun">.</span><span class="pln">set_threshold</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">,</span> <span class="lit">15</span><span class="pun">,</span> <span class="lit">15</span><span class="pun">)</span><br /><span class="pun">&gt;&gt;&gt;</span><span class="pln"> gc</span><span class="pun">.</span><span class="pln">get_threshold</span><span class="pun">()</span><br /><span class="pun">(</span><span class="lit">1000</span><span class="pun">,</span> <span class="lit">15</span><span class="pun">,</span> <span class="lit">15</span><span class="pun">)</span></pre>
</body>
</html>